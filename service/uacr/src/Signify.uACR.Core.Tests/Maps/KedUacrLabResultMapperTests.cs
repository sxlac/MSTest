using System.Text.Json;
using FluentAssertions;
using Signify.uACR.Core.Events;
using Signify.uACR.Core.Exceptions;
using Signify.uACR.Core.Maps;
using Xunit;

namespace Signify.uACR.Core.Tests.Maps;

public class KedUacrLabResultMapperTests
{
    [Fact]
    public void Convert_JsonElement_To_KedUacrLabResult_ReturnsNotNull()
    {
        // Arrange
        var subject = new KedUacrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"type\":\"searchset\",\"timestamp\":\"2024-11-28T15:58:12.006+00:00\",\"meta\":{\"lastUpdated\":\"2024-11-28T15:58:12.006+00:00\",\"versionId\":\"c2e962b0-6a07-488e-844e-a2b35666debc\"},\"entry\":[{\"fullUrl\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport/9a386dbb-7c19-4cb9-b772-5822fbb617d6\",\"search\":{\"mode\":\"match\"},\"resource\":{\"resourceType\":\"DiagnosticReport\",\"meta\":{\"versionId\":\"bad878ea-743d-492e-a0a9-e7bb28c698c1\",\"lastUpdated\":\"2024-11-22T15:20:21.215+00:00\"},\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"25ce82a2-1453-4922-9316-1a041f31ed2c\",\"identifier\":[{\"system\":\"http://ihr.signify.com/participantId\",\"value\":\"566215\"}],\"name\":[{\"family\":\"Doe\",\"given\":[\"John\"]}],\"telecom\":[{\"system\":\"phone\",\"value\":\"5029997778\"},{\"system\":\"email\",\"value\":\"bkutacho566215@letsgetchecked.com\"}],\"gender\":\"male\",\"birthDate\":\"1998-04-05\",\"address\":[{\"line\":[\"2485 Ice Town Rd\",\"Boston, Kentucky(KY)\"],\"city\":\"Boston\",\"state\":\"California\",\"postalCode\":\"40103\",\"country\":\"US\"}]},{\"resourceType\":\"Practitioner\",\"id\":\"8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"identifier\":[{\"system\":\"http://hl7.org/fhir/sid/us-npi\",\"value\":\"1821020579\"}],\"name\":[{\"family\":\"Mordkin\",\"given\":[\"Robert\"]}]},{\"resourceType\":\"Observation\",\"id\":\"b16b3d33-ecd8-4fcc-9496-b424118a70ea\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"}],\"text\":\"Creatinine\"},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":1,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"note\":[{\"text\":\"Your test result shows your creatinine levels are normal. Creatinine is a waste product produced by your muscles. Your kidneys filter and remove creatinine from the blood and release it into your urine. The amount of creatinine produced depends on your size and muscle mass. Even though this test result is normal, if you are experiencing any symptoms, you should follow up with your healthcare provider. You can download your lab report to view your results and reference ranges.\"}],\"referenceRange\":[{\"low\":{\"value\":0.67,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"high\":{\"value\":1.17,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"}}]},{\"resourceType\":\"Observation\",\"id\":\"6ce30801-319d-443d-b1fc-cfa8e019adbd\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}],\"text\":\"Creatinine in Urine\"},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":120,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"},\"note\":[{\"text\":\"Your Urine Albumin Creatinine ratio (UACR) is normal. This test measures how much albumin is in your urine and found your levels to be normal. When high levels of albumin are found in the urine it can be an early indicator of kidney disease, however, your levels were normal. Please share this test result with your healthcare provider. Even though your test is normal, if you are experiencing any symptoms or are concerned about your health, you should speak to your healthcare provider.\"}],\"referenceRange\":[{\"low\":{\"value\":30,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"},\"high\":{\"value\":300,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"}}]},{\"resourceType\":\"Observation\",\"id\":\"4995f64e-6125-4fcd-9536-a8dc928b41ce\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"}],\"text\":\"Estimated Glomerular Filtration Rate\"},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":90,\"unit\":\"ml/min/1.73M2\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"ml/min/1.73m2\"},\"note\":[{\"text\":\"Your eGFR result is normal. This result is an estimated calculation that helps determine how well your kidneys are filtering blood using different factors including your creatinine level, age, and sex. A result between 60 and 90 shows slightly reduced kidney function. This can be a result of many factors including infection, certain medications, or health conditions or it could be an early sign of kidney disease. You should share this result with your healthcare provider to assess your risk of kidney disease. A result above 90 is optimal. The best ways to keep your kidneys healthy are staying hydrated, a healthy balanced diet, exercise, and not smoking. It’s important to check for health conditions such as diabetes, high blood pressure, and high cholesterol. If you have any of these conditions it is very important to keep your blood sugar levels, blood pressure, and cholesterol under control and to speak to your healthcare provider about how best to manage your risk.\"}],\"referenceRange\":[{\"low\":{\"value\":60,\"unit\":\"ml/min/1.73M2\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"ml/min/1.73m2\"}}]}],\"identifier\":[{\"system\":\"http://letsgetchecked.com/results/barcode\",\"value\":\"LGC-0247-0920-8227\"},{\"system\":\"http://letsgetchecked.com/results/alphaCode\",\"value\":\"AQUBNF\"}],\"status\":\"final\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"},{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"},{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}]},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"result\":[{\"reference\":\"#b16b3d33-ecd8-4fcc-9496-b424118a70ea\"},{\"reference\":\"#6ce30801-319d-443d-b1fc-cfa8e019adbd\"},{\"reference\":\"#4995f64e-6125-4fcd-9536-a8dc928b41ce\"}],\"id\":\"9a386dbb-7c19-4cb9-b772-5822fbb617d6\"}}],\"total\":1,\"link\":[{\"relation\":\"self\",\"url\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport?identifier=http%3a%2f%2fletsgetchecked.com%2fresults%2fbarcode%7cLGC-0247-0920-8227&_count=10&_skip=0\"}],\"id\":\"692e574d-853f-4178-89a1-7343d8efddbd\"}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var actual = subject.Convert(source, new KedUacrLabResult(), null);

        // Assert
        Assert.NotNull(actual);
        Assert.Equal(120, actual.UacrResult);
        Assert.Null(actual.UrineAlbuminToCreatinineRatioResultDescription);
        Assert.Equal(566215, actual.EvaluationId);
    }
    
        [Fact]
    public void Convert_JsonElement_To_KedUacrLabResult_ReturnsUndetermined()
    {
        // Arrange
        var subject = new KedUacrLabResultMapper();
        var expectedInterpretationText = "NotAvailable";
        const string json = "{\"resourceType\":\"Bundle\",\"type\":\"searchset\",\"timestamp\":\"2024-11-28T15:58:12.006+00:00\",\"meta\":{\"lastUpdated\":\"2024-11-28T15:58:12.006+00:00\",\"versionId\":\"c2e962b0-6a07-488e-844e-a2b35666debc\"},\"entry\":[{\"fullUrl\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport/9a386dbb-7c19-4cb9-b772-5822fbb617d6\",\"search\":{\"mode\":\"match\"},\"resource\":{\"resourceType\":\"DiagnosticReport\",\"meta\":{\"versionId\":\"bad878ea-743d-492e-a0a9-e7bb28c698c1\",\"lastUpdated\":\"2024-11-22T15:20:21.215+00:00\"},\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"25ce82a2-1453-4922-9316-1a041f31ed2c\",\"identifier\":[{\"system\":\"http://ihr.signify.com/participantId\",\"value\":\"566215\"}],\"name\":[{\"family\":\"Doe\",\"given\":[\"John\"]}],\"telecom\":[{\"system\":\"phone\",\"value\":\"5029997778\"},{\"system\":\"email\",\"value\":\"bkutacho566215@letsgetchecked.com\"}],\"gender\":\"male\",\"birthDate\":\"1998-04-05\",\"address\":[{\"line\":[\"2485 Ice Town Rd\",\"Boston, Kentucky(KY)\"],\"city\":\"Boston\",\"state\":\"California\",\"postalCode\":\"40103\",\"country\":\"US\"}]},{\"resourceType\":\"Practitioner\",\"id\":\"8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"identifier\":[{\"system\":\"http://hl7.org/fhir/sid/us-npi\",\"value\":\"1821020579\"}],\"name\":[{\"family\":\"Mordkin\",\"given\":[\"Robert\"]}]},{\"resourceType\":\"Observation\",\"id\":\"b16b3d33-ecd8-4fcc-9496-b424118a70ea\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"}],\"text\":\"Creatinine\"},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"interpretation\": [\n                            {\n                                \"text\": \"NotAvailable\"\n                            }\n                        ],\"note\":[{\"text\":\"Your test result shows your creatinine levels are normal. Creatinine is a waste product produced by your muscles. Your kidneys filter and remove creatinine from the blood and release it into your urine. The amount of creatinine produced depends on your size and muscle mass. Even though this test result is normal, if you are experiencing any symptoms, you should follow up with your healthcare provider. You can download your lab report to view your results and reference ranges.\"}],\"referenceRange\":[{\"low\":{\"value\":0.67,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"high\":{\"value\":1.17,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"}}]},{\"resourceType\":\"Observation\",\"id\":\"6ce30801-319d-443d-b1fc-cfa8e019adbd\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}],\"text\":\"Creatinine in Urine\"},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"interpretation\": [\n                            {\n                                \"text\": \"NotAvailable\"\n                            }\n                        ],\"note\":[{\"text\":\"Your Urine Albumin Creatinine ratio (UACR) is normal. This test measures how much albumin is in your urine and found your levels to be normal. When high levels of albumin are found in the urine it can be an early indicator of kidney disease, however, your levels were normal. Please share this test result with your healthcare provider. Even though your test is normal, if you are experiencing any symptoms or are concerned about your health, you should speak to your healthcare provider.\"}],\"referenceRange\":[{\"low\":{\"value\":30,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"},\"high\":{\"value\":300,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"}}]},{\"resourceType\":\"Observation\",\"id\":\"4995f64e-6125-4fcd-9536-a8dc928b41ce\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"}],\"text\":\"Estimated Glomerular Filtration Rate\"},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":90,\"unit\":\"ml/min/1.73M2\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"ml/min/1.73m2\"},\"note\":[{\"text\":\"Your eGFR result is normal. This result is an estimated calculation that helps determine how well your kidneys are filtering blood using different factors including your creatinine level, age, and sex. A result between 60 and 90 shows slightly reduced kidney function. This can be a result of many factors including infection, certain medications, or health conditions or it could be an early sign of kidney disease. You should share this result with your healthcare provider to assess your risk of kidney disease. A result above 90 is optimal. The best ways to keep your kidneys healthy are staying hydrated, a healthy balanced diet, exercise, and not smoking. It’s important to check for health conditions such as diabetes, high blood pressure, and high cholesterol. If you have any of these conditions it is very important to keep your blood sugar levels, blood pressure, and cholesterol under control and to speak to your healthcare provider about how best to manage your risk.\"}],\"referenceRange\":[{\"low\":{\"value\":60,\"unit\":\"ml/min/1.73M2\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"ml/min/1.73m2\"}}]}],\"identifier\":[{\"system\":\"http://letsgetchecked.com/results/barcode\",\"value\":\"LGC-0247-0920-8227\"},{\"system\":\"http://letsgetchecked.com/results/alphaCode\",\"value\":\"AQUBNF\"}],\"status\":\"final\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"},{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"},{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}]},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"result\":[{\"reference\":\"#b16b3d33-ecd8-4fcc-9496-b424118a70ea\"},{\"reference\":\"#6ce30801-319d-443d-b1fc-cfa8e019adbd\"},{\"reference\":\"#4995f64e-6125-4fcd-9536-a8dc928b41ce\"}],\"id\":\"9a386dbb-7c19-4cb9-b772-5822fbb617d6\"}}],\"total\":1,\"link\":[{\"relation\":\"self\",\"url\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport?identifier=http%3a%2f%2fletsgetchecked.com%2fresults%2fbarcode%7cLGC-0247-0920-8227&_count=10&_skip=0\"}],\"id\":\"692e574d-853f-4178-89a1-7343d8efddbd\"}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var actual = subject.Convert(source, new KedUacrLabResult(), null);

        // Assert
        Assert.NotNull(actual);
        Assert.Null(actual.UacrResult);
        Assert.Equal(expectedInterpretationText, actual.UrineAlbuminToCreatinineRatioResultDescription);
        Assert.Equal(566215, actual.EvaluationId);
    }

    [Fact]
    public void Convert_FromJsonElement_To_KedUacrLabResult_WithNoDiagnosticReport_Returns_Exception()
    {
        // Arrange
        var subject = new KedUacrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"entry\":[{\"resource\":{\"resourceType\":\"Patient\",\"identifier\":[{\"system\":\"http://hospital.smarthealthit.org\",\"value\":\"12345\"}]}}]}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var actual = Assert.Throws<FhirParseDiagnosticReportException>(() => { subject.Convert(source, new KedUacrLabResult(), null); }  );
        
        actual.Message.Should().Be("DiagnosticReport: No DiagnosticReport found in the Bundle.");
    }
    
    [Fact]
    public void Convert_FromJsonElement_To_KedUacrLabResult_WithNoPatient_Returns_Exception()
    {
        // Arrange
        var subject = new KedUacrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"entry\":[{\"resource\":{\"resourceType\":\"DiagnosticReport\",\"contained\":[{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"14959-1\"}]}},{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"2160-0\"}]}},{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\"}]}}]}}]}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var result = Assert.Throws<FhirParsePatientException>(() => { subject.Convert(source, new KedUacrLabResult(), null); });
    
        // Assert
        result.Message.Should().Be("Patient: No Patient found in the DiagnosticReport.");
    }

    [Fact]
    public void Convert_FromJsonElement_To_KedUacrLabResult_WithPatientButNoIdentifier_Returns_Exception()
    {
        // Arrange
        var subject = new KedUacrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"entry\":[{\"resource\":{\"resourceType\":\"DiagnosticReport\",\"contained\":[{\"resourceType\":\"Patient\"},{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"14959-1\"}]}},{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"2160-0\"}]}},{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\"}]}}]}}]}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var result = Assert.Throws<FhirParsePatientException>(() => { subject.Convert(source, new KedUacrLabResult(), null); });
    
        // Assert
        result.Message.Should().Be("Patient: No ParticipantId found in the DiagnosticReport.");
    }
    
    [Fact]
    public void Convert_FromJsonElement_To_KedUacrLabResult_WithNoObservation_Returns_Exception()
    {
        // Arrange
        var subject = new KedUacrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"type\":\"searchset\",\"timestamp\":\"2024-12-18T12:24:12.094+00:00\",\"meta\":{\"lastUpdated\":\"2024-12-18T12:24:12.094+00:00\",\"versionId\":\"c6781c99-7483-4b11-9a40-6dcb5008c7e8\"},\"entry\":[{\"fullUrl\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport/22ae1c07-312e-41e9-9228-57530f1a47bb\",\"search\":{\"mode\":\"match\"},\"resource\":{\"resourceType\":\"DiagnosticReport\",\"meta\":{\"versionId\":\"5b0f9ccd-3283-4932-8c4e-139f460a9257\",\"lastUpdated\":\"2024-11-22T15:20:33.032+00:00\"},\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"identifier\":[{\"system\":\"http://ihr.signify.com/participantId\",\"value\":\"457238\"}],\"name\":[{\"family\":\"Doe\",\"given\":[\"John\"]}],\"telecom\":[{\"system\":\"phone\",\"value\":\"5029997778\"},{\"system\":\"email\",\"value\":\"bkutacho457238@letsgetchecked.com\"}],\"gender\":\"male\",\"birthDate\":\"1998-04-05\",\"address\":[{\"line\":[\"2485 Ice Town Rd\",\"Boston, Kentucky(KY)\"],\"city\":\"Boston\",\"state\":\"California\",\"postalCode\":\"40103\",\"country\":\"US\"}]},{\"resourceType\":\"Practitioner\",\"id\":\"1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"identifier\":[{\"system\":\"http://hl7.org/fhir/sid/us-npi\",\"value\":\"1821020579\"}],\"name\":[{\"family\":\"Mordkin\",\"given\":[\"Robert\"]}]}],\"identifier\":[{\"system\":\"http://letsgetchecked.com/results/barcode\",\"value\":\"LGC-0247-0926-1250\"},{\"system\":\"http://letsgetchecked.com/results/alphaCode\",\"value\":\"AQUBNJ\"}],\"status\":\"final\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"},{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"},{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}]},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"result\":[{\"reference\":\"#57a386f0-84dc-484d-8d75-2cf3f3fe0299\"},{\"reference\":\"#fe27432a-d016-4a84-99d3-5d644850e229\"},{\"reference\":\"#a0b63d0e-fa5a-4487-9550-0b655a44a9f1\"}],\"id\":\"22ae1c07-312e-41e9-9228-57530f1a47bb\"}}],\"total\":1,\"link\":[{\"relation\":\"self\",\"url\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport?identifier=http%3a%2f%2fletsgetchecked.com%2fresults%2fbarcode%7cLGC-0247-0926-1250&_total=accurate&_count=1&_skip=0\"}],\"id\":\"fb949a06-89de-4e60-a8fc-f17365f14815\"}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var result = Assert.Throws<FhirParseObservationException>(() => { subject.Convert(source, new KedUacrLabResult(), null); });
    
        // Assert
        result.Message.Should().Be("Observation: No matching observation found or observation value is null. EvaluationId: 457238");
    }
    
    [Fact]
    public void Convert_FromJsonElement_To_KedUacrLabResult_WithObservationNoteNull_Returns_Exception()
    {
        // Arrange
        var subject = new KedUacrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"type\":\"searchset\",\"timestamp\":\"2024-12-18T12:24:12.094+00:00\",\"meta\":{\"lastUpdated\":\"2024-12-18T12:24:12.094+00:00\",\"versionId\":\"c6781c99-7483-4b11-9a40-6dcb5008c7e8\"},\"entry\":[{\"fullUrl\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport/22ae1c07-312e-41e9-9228-57530f1a47bb\",\"search\":{\"mode\":\"match\"},\"resource\":{\"resourceType\":\"DiagnosticReport\",\"meta\":{\"versionId\":\"5b0f9ccd-3283-4932-8c4e-139f460a9257\",\"lastUpdated\":\"2024-11-22T15:20:33.032+00:00\"},\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"identifier\":[{\"system\":\"http://ihr.signify.com/participantId\",\"value\":\"457238\"}],\"name\":[{\"family\":\"Doe\",\"given\":[\"John\"]}],\"telecom\":[{\"system\":\"phone\",\"value\":\"5029997778\"},{\"system\":\"email\",\"value\":\"bkutacho457238@letsgetchecked.com\"}],\"gender\":\"male\",\"birthDate\":\"1998-04-05\",\"address\":[{\"line\":[\"2485 Ice Town Rd\",\"Boston, Kentucky(KY)\"],\"city\":\"Boston\",\"state\":\"California\",\"postalCode\":\"40103\",\"country\":\"US\"}]},{\"resourceType\":\"Practitioner\",\"id\":\"1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"identifier\":[{\"system\":\"http://hl7.org/fhir/sid/us-npi\",\"value\":\"1821020579\"}],\"name\":[{\"family\":\"Mordkin\",\"given\":[\"Robert\"]}]},{\"resourceType\":\"Observation\",\"id\":\"57a386f0-84dc-484d-8d75-2cf3f3fe0299\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"}],\"text\":\"Creatinine\"},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":1,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"note\":[{\"text\":\"Your test result shows your creatinine levels are normal. Creatinine is a waste product produced by your muscles. Your kidneys filter and remove creatinine from the blood and release it into your urine. The amount of creatinine produced depends on your size and muscle mass. Even though this test result is normal, if you are experiencing any symptoms, you should follow up with your healthcare provider. You can download your lab report to view your results and reference ranges.\"}],\"referenceRange\":[{\"low\":{\"value\":0.67,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"high\":{\"value\":1.17,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"}}]},{\"resourceType\":\"Observation\",\"id\":\"fe27432a-d016-4a84-99d3-5d644850e229\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}],\"text\":\"Creatinine in Urine\"},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":120,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"},\"note\":[{\"text\":\"\"}],\"referenceRange\":[{\"low\":{\"value\":30,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"},\"high\":{\"value\":300,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"}}]},{\"resourceType\":\"Observation\",\"id\":\"a0b63d0e-fa5a-4487-9550-0b655a44a9f1\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"}],\"text\":\"Estimated Glomerular Filtration Rate\"},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":90,\"unit\":\"ml/min/1.73M2\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"ml/min/1.73m2\"},\"note\":[{\"text\":\"\"}],\"referenceRange\":[{\"low\":{\"value\":60,\"unit\":\"ml/min/1.73M2\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"ml/min/1.73m2\"}}]}],\"identifier\":[{\"system\":\"http://letsgetchecked.com/results/barcode\",\"value\":\"LGC-0247-0926-1250\"},{\"system\":\"http://letsgetchecked.com/results/alphaCode\",\"value\":\"AQUBNJ\"}],\"status\":\"final\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"},{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"},{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}]},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"result\":[{\"reference\":\"#57a386f0-84dc-484d-8d75-2cf3f3fe0299\"},{\"reference\":\"#fe27432a-d016-4a84-99d3-5d644850e229\"},{\"reference\":\"#a0b63d0e-fa5a-4487-9550-0b655a44a9f1\"}],\"id\":\"22ae1c07-312e-41e9-9228-57530f1a47bb\"}}],\"total\":1,\"link\":[{\"relation\":\"self\",\"url\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport?identifier=http%3a%2f%2fletsgetchecked.com%2fresults%2fbarcode%7cLGC-0247-0926-1250&_total=accurate&_count=1&_skip=0\"}],\"id\":\"fb949a06-89de-4e60-a8fc-f17365f14815\"}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var result = Assert.Throws<FhirParseObservationException>(() => { subject.Convert(source, new KedUacrLabResult(), null); });
    
        // Assert
        result.Message.Should().Be("Observation: No matching observation found or observation value is null. EvaluationId: 457238");
    }

    [Theory]
    [InlineData("mg/dL")]
    [InlineData("g/L")]
    [InlineData("mmol/L")]
    [InlineData("mL/min/1.73m2")]
    public void Convert_FromJsonElement_To_KedUacrLabResult_WithInvalidUnits_Throws_FhirParseException(string invalidUnit)
    {
        var testUnit = "blah";
        // Arrange
        var subject = new KedUacrLabResultMapper();
        string json =
            "{\"resourceType\":\"Bundle\",\"type\":\"searchset\",\"timestamp\":\"2024-11-28T15:58:12.006+00:00\",\"meta\":{\"lastUpdated\":\"2024-11-28T15:58:12.006+00:00\",\"versionId\":\"c2e962b0-6a07-488e-844e-a2b35666debc\"},\"entry\":[{\"fullUrl\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport/9a386dbb-7c19-4cb9-b772-5822fbb617d6\",\"search\":{\"mode\":\"match\"},\"resource\":{\"resourceType\":\"DiagnosticReport\",\"meta\":{\"versionId\":\"bad878ea-743d-492e-a0a9-e7bb28c698c1\",\"lastUpdated\":\"2024-11-22T15:20:21.215+00:00\"},\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"25ce82a2-1453-4922-9316-1a041f31ed2c\",\"identifier\":[{\"system\":\"http://ihr.signify.com/participantId\",\"value\":\"566215\"}],\"name\":[{\"family\":\"Doe\",\"given\":[\"John\"]}],\"telecom\":[{\"system\":\"phone\",\"value\":\"5029997778\"},{\"system\":\"email\",\"value\":\"bkutacho566215@letsgetchecked.com\"}],\"gender\":\"male\",\"birthDate\":\"1998-04-05\",\"address\":[{\"line\":[\"2485 Ice Town Rd\",\"Boston, Kentucky(KY)\"],\"city\":\"Boston\",\"state\":\"California\",\"postalCode\":\"40103\",\"country\":\"US\"}]},{\"resourceType\":\"Practitioner\",\"id\":\"8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"identifier\":[{\"system\":\"http://hl7.org/fhir/sid/us-npi\",\"value\":\"1821020579\"}],\"name\":[{\"family\":\"Mordkin\",\"given\":[\"Robert\"]}]},{\"resourceType\":\"Observation\",\"id\":\"b16b3d33-ecd8-4fcc-9496-b424118a70ea\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"}],\"text\":\"Creatinine\"},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":1,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"note\":[{\"text\":\"Your test result shows your creatinine levels are normal. Creatinine is a waste product produced by your muscles. Your kidneys filter and remove creatinine from the blood and release it into your urine. The amount of creatinine produced depends on your size and muscle mass. Even though this test result is normal, if you are experiencing any symptoms, you should follow up with your healthcare provider. You can download your lab report to view your results and reference ranges.\"}],\"referenceRange\":[{\"low\":{\"value\":0.67,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"high\":{\"value\":1.17,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"}}]},{\"resourceType\":\"Observation\",\"id\":\"6ce30801-319d-443d-b1fc-cfa8e019adbd\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}],\"text\":\"Creatinine in Urine\"},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":120,\"unit\":\"" +
            testUnit +
            "\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"" + invalidUnit +
            "\"},\"note\":[{\"text\":\"Your Urine Albumin Creatinine ratio (UACR) is normal. This test measures how much albumin is in your urine and found your levels to be normal. When high levels of albumin are found in the urine it can be an early indicator of kidney disease, however, your levels were normal. Please share this test result with your healthcare provider. Even though your test is normal, if you are experiencing any symptoms or are concerned about your health, you should speak to your healthcare provider.\"}],\"referenceRange\":[{\"low\":{\"value\":30,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"},\"high\":{\"value\":300,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"}}]},{\"resourceType\":\"Observation\",\"id\":\"4995f64e-6125-4fcd-9536-a8dc928b41ce\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"}],\"text\":\"Estimated Glomerular Filtration Rate\"},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":90,\"unit\":\"ml/min/1.73M2\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"ml/min/1.73m2\"},\"note\":[{\"text\":\"Your eGFR result is normal. This result is an estimated calculation that helps determine how well your kidneys are filtering blood using different factors including your creatinine level, age, and sex. A result between 60 and 90 shows slightly reduced kidney function. This can be a result of many factors including infection, certain medications, or health conditions or it could be an early sign of kidney disease. You should share this result with your healthcare provider to assess your risk of kidney disease. A result above 90 is optimal. The best ways to keep your kidneys healthy are staying hydrated, a healthy balanced diet, exercise, and not smoking. It’s important to check for health conditions such as diabetes, high blood pressure, and high cholesterol. If you have any of these conditions it is very important to keep your blood sugar levels, blood pressure, and cholesterol under control and to speak to your healthcare provider about how best to manage your risk.\"}],\"referenceRange\":[{\"low\":{\"value\":60,\"unit\":\"ml/min/1.73M2\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"ml/min/1.73m2\"}}]}],\"identifier\":[{\"system\":\"http://letsgetchecked.com/results/barcode\",\"value\":\"LGC-0247-0920-8227\"},{\"system\":\"http://letsgetchecked.com/results/alphaCode\",\"value\":\"AQUBNF\"}],\"status\":\"final\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"},{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"},{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}]},\"subject\":{\"reference\":\"#25ce82a2-1453-4922-9316-1a041f31ed2c\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:18:34.72+00:00\",\"performer\":[{\"reference\":\"#8cc0a95d-8f2c-4594-8cca-f4c714da9fc0\",\"display\":\"Robert Mordkin\"}],\"result\":[{\"reference\":\"#b16b3d33-ecd8-4fcc-9496-b424118a70ea\"},{\"reference\":\"#6ce30801-319d-443d-b1fc-cfa8e019adbd\"},{\"reference\":\"#4995f64e-6125-4fcd-9536-a8dc928b41ce\"}],\"id\":\"9a386dbb-7c19-4cb9-b772-5822fbb617d6\"}}],\"total\":1,\"link\":[{\"relation\":\"self\",\"url\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport?identifier=http%3a%2f%2fletsgetchecked.com%2fresults%2fbarcode%7cLGC-0247-0920-8227&_count=10&_skip=0\"}],\"id\":\"692e574d-853f-4178-89a1-7343d8efddbd\"}";
        var source = JsonDocument.Parse(json).RootElement;

        // Act
        var exception = Assert.Throws<FhirParseObservationException>(() => subject.Convert(source, new KedUacrLabResult(), null));

        // Assert
        exception.Message.Should().Be($"Observation: Invalid units:{invalidUnit} EvaluationId: 566215");
    }
}