using System.Text.Json;
using Signify.eGFR.Core.Events;
using Signify.eGFR.Core.Exceptions;
using Signify.eGFR.Core.Maps;
using Xunit;

namespace Signify.eGFR.Core.Tests.Maps;

public class EgfrLabResultMapperTests
{
    [Fact]
    public void Convert_JsonElement_To_KedEgfrLabResult_ReturnsNotNull()
    {
        // Arrange
        var subject = new KedEgfrLabResultMapper();
        const string json = "{\r\n    \"resourceType\": \"Bundle\",\r\n    \"type\": \"searchset\",\r\n    \"timestamp\": \"2025-01-14T13:51:54.749+00:00\",\r\n    \"meta\": {\r\n        \"lastUpdated\": \"2025-01-14T13:51:54.749+00:00\",\r\n        \"versionId\": \"d11e70f7-e3f8-4d07-92fb-cbd48058c156\"\r\n    },\r\n    \"entry\": [\r\n        {\r\n            \"fullUrl\": \"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport/22ae1c07-312e-41e9-9228-57530f1a47bb\",\r\n            \"search\": {\r\n                \"mode\": \"match\"\r\n            },\r\n            \"resource\": {\r\n                \"resourceType\": \"DiagnosticReport\",\r\n                \"meta\": {\r\n                    \"versionId\": \"5b0f9ccd-3283-4932-8c4e-139f460a9257\",\r\n                    \"lastUpdated\": \"2024-11-22T15:20:33.032+00:00\"\r\n                },\r\n                \"contained\": [\r\n                    {\r\n                        \"resourceType\": \"Patient\",\r\n                        \"id\": \"f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                        \"identifier\": [\r\n                            {\r\n                                \"system\": \"http://ihr.signify.com/participantId\",\r\n                                \"value\": \"566215\"\r\n                            }\r\n                        ],\r\n                        \"name\": [\r\n                            {\r\n                                \"family\": \"Doe\",\r\n                                \"given\": [\r\n                                    \"John\"\r\n                                ]\r\n                            }\r\n                        ],\r\n                        \"telecom\": [\r\n                            {\r\n                                \"system\": \"phone\",\r\n                                \"value\": \"5029997778\"\r\n                            },\r\n                            {\r\n                                \"system\": \"email\",\r\n                                \"value\": \"bkutacho457238@letsgetchecked.com\"\r\n                            }\r\n                        ],\r\n                        \"gender\": \"male\",\r\n                        \"birthDate\": \"1998-04-05\",\r\n                        \"address\": [\r\n                            {\r\n                                \"line\": [\r\n                                    \"2485 Ice Town Rd\",\r\n                                    \"Boston, Kentucky(KY)\"\r\n                                ],\r\n                                \"city\": \"Boston\",\r\n                                \"state\": \"California\",\r\n                                \"postalCode\": \"40103\",\r\n                                \"country\": \"US\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Practitioner\",\r\n                        \"id\": \"1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                        \"identifier\": [\r\n                            {\r\n                                \"system\": \"http://hl7.org/fhir/sid/us-npi\",\r\n                                \"value\": \"1821020579\"\r\n                            }\r\n                        ],\r\n                        \"name\": [\r\n                            {\r\n                                \"family\": \"Mordkin\",\r\n                                \"given\": [\r\n                                    \"Robert\"\r\n                                ]\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Observation\",\r\n                        \"id\": \"57a386f0-84dc-484d-8d75-2cf3f3fe0299\",\r\n                        \"status\": \"final\",\r\n                        \"category\": [\r\n                            {\r\n                                \"coding\": [\r\n                                    {\r\n                                        \"system\": \"http://terminology.hl7.org/CodeSystem/observation-category\",\r\n                                        \"code\": \"laboratory\",\r\n                                        \"display\": \"Laboratory\"\r\n                                    }\r\n                                ],\r\n                                \"text\": \"Laboratory\"\r\n                            }\r\n                        ],\r\n                        \"code\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"http://loinc.org\",\r\n                                    \"code\": \"2160-0\",\r\n                                    \"display\": \"Creatinine\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"Creatinine\"\r\n                        },\r\n                        \"subject\": {\r\n                            \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                            \"display\": \"John Doe\"\r\n                        },\r\n                        \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                        \"performer\": [\r\n                            {\r\n                                \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                                \"display\": \"Robert Mordkin\"\r\n                            }\r\n                        ],\r\n                        \"valueQuantity\": {\r\n                            \"value\": 1,\r\n                            \"unit\": \"mg/dL\",\r\n                            \"system\": \"http://unitsofmeasure.org\",\r\n                            \"code\": \"mg/dL\"\r\n                        },\r\n                        \"note\": [\r\n                            {\r\n                                \"text\": \"Your test result shows your creatinine levels are normal. Creatinine is a waste product produced by your muscles. Your kidneys filter and remove creatinine from the blood and release it into your urine. The amount of creatinine produced depends on your size and muscle mass. Even though this test result is normal, if you are experiencing any symptoms, you should follow up with your healthcare provider. You can download your lab report to view your results and reference ranges.\"\r\n                            }\r\n                        ],\r\n                        \"referenceRange\": [\r\n                            {\r\n                                \"low\": {\r\n                                    \"value\": 0.67,\r\n                                    \"unit\": \"mg/dL\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/dL\"\r\n                                },\r\n                                \"high\": {\r\n                                    \"value\": 1.17,\r\n                                    \"unit\": \"mg/dL\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/dL\"\r\n                                }\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Observation\",\r\n                        \"id\": \"fe27432a-d016-4a84-99d3-5d644850e229\",\r\n                        \"status\": \"final\",\r\n                        \"category\": [\r\n                            {\r\n                                \"coding\": [\r\n                                    {\r\n                                        \"system\": \"http://terminology.hl7.org/CodeSystem/observation-category\",\r\n                                        \"code\": \"laboratory\",\r\n                                        \"display\": \"Laboratory\"\r\n                                    }\r\n                                ],\r\n                                \"text\": \"Laboratory\"\r\n                            }\r\n                        ],\r\n                        \"code\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"http://loinc.org\",\r\n                                    \"code\": \"14959-1\",\r\n                                    \"display\": \"Creatinine in Urine\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"Creatinine in Urine\"\r\n                        },\r\n                        \"subject\": {\r\n                            \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                            \"display\": \"John Doe\"\r\n                        },\r\n                        \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                        \"performer\": [\r\n                            {\r\n                                \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                                \"display\": \"Robert Mordkin\"\r\n                            }\r\n                        ],\r\n                        \"valueQuantity\": {\r\n                            \"value\": 120,\r\n                            \"unit\": \"mg/g\",\r\n                            \"system\": \"http://unitsofmeasure.org\",\r\n                            \"code\": \"mg/g\"\r\n                        },\r\n                        \"note\": [\r\n                            {\r\n                                \"text\": \"Your Urine Albumin Creatinine ratio (UACR) is normal. This test measures how much albumin is in your urine and found your levels to be normal. When high levels of albumin are found in the urine it can be an early indicator of kidney disease, however, your levels were normal. Please share this test result with your healthcare provider. Even though your test is normal, if you are experiencing any symptoms or are concerned about your health, you should speak to your healthcare provider.\"\r\n                            }\r\n                        ],\r\n                        \"referenceRange\": [\r\n                            {\r\n                                \"low\": {\r\n                                    \"value\": 30,\r\n                                    \"unit\": \"mg/g\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/g\"\r\n                                },\r\n                                \"high\": {\r\n                                    \"value\": 300,\r\n                                    \"unit\": \"mg/g\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/g\"\r\n                                }\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Observation\",\r\n                        \"id\": \"a0b63d0e-fa5a-4487-9550-0b655a44a9f1\",\r\n                        \"status\": \"final\",\r\n                        \"category\": [\r\n                            {\r\n                                \"coding\": [\r\n                                    {\r\n                                        \"system\": \"http://terminology.hl7.org/CodeSystem/observation-category\",\r\n                                        \"code\": \"laboratory\",\r\n                                        \"display\": \"Laboratory\"\r\n                                    }\r\n                                ],\r\n                                \"text\": \"Laboratory\"\r\n                            }\r\n                        ],\r\n                        \"code\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"http://loinc.org\",\r\n                                    \"code\": \"98979-8\",\r\n                                    \"display\": \"Estimated Glomerular Filtration Rate\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"Estimated Glomerular Filtration Rate\"\r\n                        },\r\n                        \"subject\": {\r\n                            \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                            \"display\": \"John Doe\"\r\n                        },\r\n                        \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                        \"performer\": [\r\n                            {\r\n                                \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                                \"display\": \"Robert Mordkin\"\r\n                            }\r\n                        ],\r\n                        \"valueQuantity\": {\r\n                            \"value\": 90,\r\n                            \"unit\": \"ml/min/1.73M2\",\r\n                            \"system\": \"http://unitsofmeasure.org\",\r\n                            \"code\": \"mL/min/1.73m2\"\r\n                        },\r\n                        \"note\": [\r\n                            {\r\n                                \"text\": \"Your eGFR result is normal. This result is an estimated calculation that helps determine how well your kidneys are filtering blood using different factors including your creatinine level, age, and sex. A result between 60 and 90 shows slightly reduced kidney function. This can be a result of many factors including infection, certain medications, or health conditions or it could be an early sign of kidney disease. You should share this result with your healthcare provider to assess your risk of kidney disease. A result above 90 is optimal. The best ways to keep your kidneys healthy are staying hydrated, a healthy balanced diet, exercise, and not smoking. It’s important to check for health conditions such as diabetes, high blood pressure, and high cholesterol. If you have any of these conditions it is very important to keep your blood sugar levels, blood pressure, and cholesterol under control and to speak to your healthcare provider about how best to manage your risk.\"\r\n                            }\r\n                        ],\r\n                        \"referenceRange\": [\r\n                            {\r\n                                \"low\": {\r\n                                    \"value\": 60,\r\n                                    \"unit\": \"ml/min/1.73M2\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mL/min/1.73m2\"\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                ],\r\n                \"identifier\": [\r\n                    {\r\n                        \"system\": \"http://letsgetchecked.com/results/barcode\",\r\n                        \"value\": \"LGC-0247-0926-1250\"\r\n                    },\r\n                    {\r\n                        \"system\": \"http://letsgetchecked.com/results/alphaCode\",\r\n                        \"value\": \"AQUBNJ\"\r\n                    }\r\n                ],\r\n                \"status\": \"final\",\r\n                \"code\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"http://loinc.org\",\r\n                            \"code\": \"98979-8\",\r\n                            \"display\": \"Estimated Glomerular Filtration Rate\"\r\n                        },\r\n                        {\r\n                            \"system\": \"http://loinc.org\",\r\n                            \"code\": \"2160-0\",\r\n                            \"display\": \"Creatinine\"\r\n                        },\r\n                        {\r\n                            \"system\": \"http://loinc.org\",\r\n                            \"code\": \"14959-1\",\r\n                            \"display\": \"Creatinine in Urine\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"subject\": {\r\n                    \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                    \"display\": \"John Doe\"\r\n                },\r\n                \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                \"performer\": [\r\n                    {\r\n                        \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                        \"display\": \"Robert Mordkin\"\r\n                    }\r\n                ],\r\n                \"result\": [\r\n                    {\r\n                        \"reference\": \"#57a386f0-84dc-484d-8d75-2cf3f3fe0299\"\r\n                    },\r\n                    {\r\n                        \"reference\": \"#fe27432a-d016-4a84-99d3-5d644850e229\"\r\n                    },\r\n                    {\r\n                        \"reference\": \"#a0b63d0e-fa5a-4487-9550-0b655a44a9f1\"\r\n                    }\r\n                ],\r\n                \"id\": \"22ae1c07-312e-41e9-9228-57530f1a47bb\"\r\n            }\r\n        }\r\n    ],\r\n    \"total\": 1,\r\n    \"link\": [\r\n        {\r\n            \"relation\": \"self\",\r\n            \"url\": \"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport?identifier=http%3a%2f%2fletsgetchecked.com%2fresults%2fbarcode%7cLGC-0247-0926-1250&_total=accurate&_count=1&_skip=0\"\r\n        }\r\n    ],\r\n    \"id\": \"40e703af-6e09-4e43-9634-0d7fafe114af\"\r\n}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var actual = subject.Convert(source, new KedEgfrLabResult(), null);

        // Assert
        Assert.NotNull(actual);
        Assert.Equal(90, actual.EgfrResult);
        Assert.Null(actual.EstimatedGlomerularFiltrationRateResultDescription);
        Assert.Equal(566215, actual.EvaluationId);
    }
    [Fact]
    public void Convert_JsonElement_To_KedEgfrLabResult_ReturnsUndetermined()
    {
        // Arrange
        var subject = new KedEgfrLabResultMapper();
        var expectedInterpretationText = "NotAvailable";
        const string json = "{\r\n    \"resourceType\": \"Bundle\",\r\n    \"type\": \"searchset\",\r\n    \"timestamp\": \"2025-01-14T13:51:54.749+00:00\",\r\n    \"meta\": {\r\n        \"lastUpdated\": \"2025-01-14T13:51:54.749+00:00\",\r\n        \"versionId\": \"d11e70f7-e3f8-4d07-92fb-cbd48058c156\"\r\n    },\r\n    \"entry\": [\r\n        {\r\n            \"fullUrl\": \"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport/22ae1c07-312e-41e9-9228-57530f1a47bb\",\r\n            \"search\": {\r\n                \"mode\": \"match\"\r\n            },\r\n            \"resource\": {\r\n                \"resourceType\": \"DiagnosticReport\",\r\n                \"meta\": {\r\n                    \"versionId\": \"5b0f9ccd-3283-4932-8c4e-139f460a9257\",\r\n                    \"lastUpdated\": \"2024-11-22T15:20:33.032+00:00\"\r\n                },\r\n                \"contained\": [\r\n                    {\r\n                        \"resourceType\": \"Patient\",\r\n                        \"id\": \"f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                        \"identifier\": [\r\n                            {\r\n                                \"system\": \"http://ihr.signify.com/participantId\",\r\n                                \"value\": \"566215\"\r\n                            }\r\n                        ],\r\n                        \"name\": [\r\n                            {\r\n                                \"family\": \"Doe\",\r\n                                \"given\": [\r\n                                    \"John\"\r\n                                ]\r\n                            }\r\n                        ],\r\n                        \"telecom\": [\r\n                            {\r\n                                \"system\": \"phone\",\r\n                                \"value\": \"5029997778\"\r\n                            },\r\n                            {\r\n                                \"system\": \"email\",\r\n                                \"value\": \"bkutacho457238@letsgetchecked.com\"\r\n                            }\r\n                        ],\r\n                        \"gender\": \"male\",\r\n                        \"birthDate\": \"1998-04-05\",\r\n                        \"address\": [\r\n                            {\r\n                                \"line\": [\r\n                                    \"2485 Ice Town Rd\",\r\n                                    \"Boston, Kentucky(KY)\"\r\n                                ],\r\n                                \"city\": \"Boston\",\r\n                                \"state\": \"California\",\r\n                                \"postalCode\": \"40103\",\r\n                                \"country\": \"US\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Practitioner\",\r\n                        \"id\": \"1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                        \"identifier\": [\r\n                            {\r\n                                \"system\": \"http://hl7.org/fhir/sid/us-npi\",\r\n                                \"value\": \"1821020579\"\r\n                            }\r\n                        ],\r\n                        \"name\": [\r\n                            {\r\n                                \"family\": \"Mordkin\",\r\n                                \"given\": [\r\n                                    \"Robert\"\r\n                                ]\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Observation\",\r\n                        \"id\": \"57a386f0-84dc-484d-8d75-2cf3f3fe0299\",\r\n                        \"status\": \"final\",\r\n                        \"category\": [\r\n                            {\r\n                                \"coding\": [\r\n                                    {\r\n                                        \"system\": \"http://terminology.hl7.org/CodeSystem/observation-category\",\r\n                                        \"code\": \"laboratory\",\r\n                                        \"display\": \"Laboratory\"\r\n                                    }\r\n                                ],\r\n                                \"text\": \"Laboratory\"\r\n                            }\r\n                        ],\r\n                        \"code\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"http://loinc.org\",\r\n                                    \"code\": \"2160-0\",\r\n                                    \"display\": \"Creatinine\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"Creatinine\"\r\n                        },\r\n                        \"subject\": {\r\n                            \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                            \"display\": \"John Doe\"\r\n                        },\r\n                        \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                        \"performer\": [\r\n                            {\r\n                                \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                                \"display\": \"Robert Mordkin\"\r\n                            }\r\n                        ],\r\n                        \"valueQuantity\": {\r\n                            \"value\": 1,\r\n                            \"unit\": \"mg/dL\",\r\n                            \"system\": \"http://unitsofmeasure.org\",\r\n                            \"code\": \"mg/dL\"\r\n                        },\r\n                        \"note\": [\r\n                            {\r\n                                \"text\": \"Your test result shows your creatinine levels are normal. Creatinine is a waste product produced by your muscles. Your kidneys filter and remove creatinine from the blood and release it into your urine. The amount of creatinine produced depends on your size and muscle mass. Even though this test result is normal, if you are experiencing any symptoms, you should follow up with your healthcare provider. You can download your lab report to view your results and reference ranges.\"\r\n                            }\r\n                        ],\r\n                        \"referenceRange\": [\r\n                            {\r\n                                \"low\": {\r\n                                    \"value\": 0.67,\r\n                                    \"unit\": \"mg/dL\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/dL\"\r\n                                },\r\n                                \"high\": {\r\n                                    \"value\": 1.17,\r\n                                    \"unit\": \"mg/dL\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/dL\"\r\n                                }\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Observation\",\r\n                        \"id\": \"fe27432a-d016-4a84-99d3-5d644850e229\",\r\n                        \"status\": \"final\",\r\n                        \"category\": [\r\n                            {\r\n                                \"coding\": [\r\n                                    {\r\n                                        \"system\": \"http://terminology.hl7.org/CodeSystem/observation-category\",\r\n                                        \"code\": \"laboratory\",\r\n                                        \"display\": \"Laboratory\"\r\n                                    }\r\n                                ],\r\n                                \"text\": \"Laboratory\"\r\n                            }\r\n                        ],\r\n                        \"code\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"http://loinc.org\",\r\n                                    \"code\": \"14959-1\",\r\n                                    \"display\": \"Creatinine in Urine\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"Creatinine in Urine\"\r\n                        },\r\n                        \"subject\": {\r\n                            \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                            \"display\": \"John Doe\"\r\n                        },\r\n                        \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                        \"performer\": [\r\n                            {\r\n                                \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                                \"display\": \"Robert Mordkin\"\r\n                            }\r\n                        ],\r\n                        \"valueQuantity\": {\r\n                            \"value\": 120,\r\n                            \"unit\": \"mg/g\",\r\n                            \"system\": \"http://unitsofmeasure.org\",\r\n                            \"code\": \"mg/g\"\r\n                        },\r\n                        \"note\": [\r\n                            {\r\n                                \"text\": \"Your Urine Albumin Creatinine ratio (UACR) is normal. This test measures how much albumin is in your urine and found your levels to be normal. When high levels of albumin are found in the urine it can be an early indicator of kidney disease, however, your levels were normal. Please share this test result with your healthcare provider. Even though your test is normal, if you are experiencing any symptoms or are concerned about your health, you should speak to your healthcare provider.\"\r\n                            }\r\n                        ],\r\n                        \"referenceRange\": [\r\n                            {\r\n                                \"low\": {\r\n                                    \"value\": 30,\r\n                                    \"unit\": \"mg/g\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/g\"\r\n                                },\r\n                                \"high\": {\r\n                                    \"value\": 300,\r\n                                    \"unit\": \"mg/g\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/g\"\r\n                                }\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Observation\",\r\n                        \"id\": \"a0b63d0e-fa5a-4487-9550-0b655a44a9f1\",\r\n                        \"status\": \"final\",\r\n                        \"category\": [\r\n                            {\r\n                                \"coding\": [\r\n                                    {\r\n                                        \"system\": \"http://terminology.hl7.org/CodeSystem/observation-category\",\r\n                                        \"code\": \"laboratory\",\r\n                                        \"display\": \"Laboratory\"\r\n                                    }\r\n                                ],\r\n                                \"text\": \"Laboratory\"\r\n                            }\r\n                        ],\r\n                        \"code\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"http://loinc.org\",\r\n                                    \"code\": \"98979-8\",\r\n                                    \"display\": \"Estimated Glomerular Filtration Rate\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"Estimated Glomerular Filtration Rate\"\r\n                        },\r\n                        \"subject\": {\r\n                            \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                            \"display\": \"John Doe\"\r\n                        },\r\n                        \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                        \"performer\": [\r\n                            {\r\n                                \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                                \"display\": \"Robert Mordkin\"\r\n                            }\r\n                        ],\r\n                        \"interpretation\": [\n                            {\n                                \"text\": \"NotAvailable\"\n                            }\n                        ],\r\n                        \"note\": [\r\n                            {\r\n                                \"text\": \"Your eGFR result is normal. This result is an estimated calculation that helps determine how well your kidneys are filtering blood using different factors including your creatinine level, age, and sex. A result between 60 and 90 shows slightly reduced kidney function. This can be a result of many factors including infection, certain medications, or health conditions or it could be an early sign of kidney disease. You should share this result with your healthcare provider to assess your risk of kidney disease. A result above 90 is optimal. The best ways to keep your kidneys healthy are staying hydrated, a healthy balanced diet, exercise, and not smoking. It’s important to check for health conditions such as diabetes, high blood pressure, and high cholesterol. If you have any of these conditions it is very important to keep your blood sugar levels, blood pressure, and cholesterol under control and to speak to your healthcare provider about how best to manage your risk.\"\r\n                            }\r\n                        ],\r\n                        \"referenceRange\": [\r\n                            {\r\n                                \"low\": {\r\n                                    \"value\": 60,\r\n                                    \"unit\": \"ml/min/1.73M2\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mL/min/1.73m2\"\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                ],\r\n                \"identifier\": [\r\n                    {\r\n                        \"system\": \"http://letsgetchecked.com/results/barcode\",\r\n                        \"value\": \"LGC-0247-0926-1250\"\r\n                    },\r\n                    {\r\n                        \"system\": \"http://letsgetchecked.com/results/alphaCode\",\r\n                        \"value\": \"AQUBNJ\"\r\n                    }\r\n                ],\r\n                \"status\": \"final\",\r\n                \"code\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"http://loinc.org\",\r\n                            \"code\": \"98979-8\",\r\n                            \"display\": \"Estimated Glomerular Filtration Rate\"\r\n                        },\r\n                        {\r\n                            \"system\": \"http://loinc.org\",\r\n                            \"code\": \"2160-0\",\r\n                            \"display\": \"Creatinine\"\r\n                        },\r\n                        {\r\n                            \"system\": \"http://loinc.org\",\r\n                            \"code\": \"14959-1\",\r\n                            \"display\": \"Creatinine in Urine\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"subject\": {\r\n                    \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                    \"display\": \"John Doe\"\r\n                },\r\n                \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                \"performer\": [\r\n                    {\r\n                        \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                        \"display\": \"Robert Mordkin\"\r\n                    }\r\n                ],\r\n                \"result\": [\r\n                    {\r\n                        \"reference\": \"#57a386f0-84dc-484d-8d75-2cf3f3fe0299\"\r\n                    },\r\n                    {\r\n                        \"reference\": \"#fe27432a-d016-4a84-99d3-5d644850e229\"\r\n                    },\r\n                    {\r\n                        \"reference\": \"#a0b63d0e-fa5a-4487-9550-0b655a44a9f1\"\r\n                    }\r\n                ],\r\n                \"id\": \"22ae1c07-312e-41e9-9228-57530f1a47bb\"\r\n            }\r\n        }\r\n    ],\r\n    \"total\": 1,\r\n    \"link\": [\r\n        {\r\n            \"relation\": \"self\",\r\n            \"url\": \"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport?identifier=http%3a%2f%2fletsgetchecked.com%2fresults%2fbarcode%7cLGC-0247-0926-1250&_total=accurate&_count=1&_skip=0\"\r\n        }\r\n    ],\r\n    \"id\": \"40e703af-6e09-4e43-9634-0d7fafe114af\"\r\n}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var actual = subject.Convert(source, new KedEgfrLabResult(), null);

        // Assert
        Assert.NotNull(actual);
        Assert.Null(actual.EgfrResult);
        Assert.Equal(expectedInterpretationText, actual.EstimatedGlomerularFiltrationRateResultDescription);
        Assert.Equal(566215, actual.EvaluationId);
    }

    [Fact]
    public void Convert_FromJsonElement_To_KedEgfrLabResult_WithNoDiagnosticReport_Returns_Exception()
    {
        // Arrange
        var subject = new KedEgfrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"entry\":[{\"resource\":{\"resourceType\":\"Patient\",\"identifier\":[{\"system\":\"http://hospital.smarthealthit.org\",\"value\":\"12345\"}]}}]}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var actual = Assert.Throws<FhirParseDiagnosticReportException>(() => { subject.Convert(source, new KedEgfrLabResult(), null); }  );
        
        Assert.Equal("DiagnosticReport: No DiagnosticReport found in the Bundle.", actual.Message);
    }
    
    [Fact]
    public void Convert_FromJsonElement_To_KedEgfrLabResult_WithNoPatient_Returns_Exception()
    {
        // Arrange
        var subject = new KedEgfrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"entry\":[{\"resource\":{\"resourceType\":\"DiagnosticReport\",\"contained\":[{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"14959-1\"}]}},{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"2160-0\"}]}},{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\"}]}}]}}]}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var result = Assert.Throws<FhirParsePatientException>(() => { subject.Convert(source, new KedEgfrLabResult(), null); });
    
        // Assert
        Assert.Equal("Patient: No Patient found in the DiagnosticReport.", result.Message);
    }

    [Fact]
    public void Convert_FromJsonElement_To_KedEgfrLabResult_WithPatientButNoIdentifier_Returns_Exception()
    {
        // Arrange
        var subject = new KedEgfrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"entry\":[{\"resource\":{\"resourceType\":\"DiagnosticReport\",\"contained\":[{\"resourceType\":\"Patient\"},{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"14959-1\"}]}},{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"2160-0\"}]}},{\"resourceType\":\"Observation\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\"}]}}]}}]}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var result = Assert.Throws<FhirParsePatientException>(() => { subject.Convert(source, new KedEgfrLabResult(), null); });
    
        // Assert
        Assert.Equal("Patient: No ParticipantId found in the DiagnosticReport.", result.Message);
    }
    
    [Fact]
    public void Convert_FromJsonElement_To_KedEgfrLabResult_WithNoObservation_Returns_Exception()
    {
        // Arrange
        var subject = new KedEgfrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"type\":\"searchset\",\"timestamp\":\"2025-01-14T13:51:54.749+00:00\",\"meta\":{\"lastUpdated\":\"2025-01-14T13:51:54.749+00:00\",\"versionId\":\"d11e70f7-e3f8-4d07-92fb-cbd48058c156\"},\"entry\":[{\"fullUrl\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport/22ae1c07-312e-41e9-9228-57530f1a47bb\",\"search\":{\"mode\":\"match\"},\"resource\":{\"resourceType\":\"DiagnosticReport\",\"meta\":{\"versionId\":\"5b0f9ccd-3283-4932-8c4e-139f460a9257\",\"lastUpdated\":\"2024-11-22T15:20:33.032+00:00\"},\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"identifier\":[{\"system\":\"http://ihr.signify.com/participantId\",\"value\":\"457238\"}],\"name\":[{\"family\":\"Doe\",\"given\":[\"John\"]}],\"telecom\":[{\"system\":\"phone\",\"value\":\"5029997778\"},{\"system\":\"email\",\"value\":\"bkutacho457238@letsgetchecked.com\"}],\"gender\":\"male\",\"birthDate\":\"1998-04-05\",\"address\":[{\"line\":[\"2485 Ice Town Rd\",\"Boston, Kentucky(KY)\"],\"city\":\"Boston\",\"state\":\"California\",\"postalCode\":\"40103\",\"country\":\"US\"}]},{\"resourceType\":\"Practitioner\",\"id\":\"1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"identifier\":[{\"system\":\"http://hl7.org/fhir/sid/us-npi\",\"value\":\"1821020579\"}],\"name\":[{\"family\":\"Mordkin\",\"given\":[\"Robert\"]}]},{\"resourceType\":\"Observation\",\"id\":\"57a386f0-84dc-484d-8d75-2cf3f3fe0299\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"}],\"text\":\"Creatinine\"},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":1,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"note\":[{\"text\":\"Your test result shows your creatinine levels are normal. Creatinine is a waste product produced by your muscles. Your kidneys filter and remove creatinine from the blood and release it into your urine. The amount of creatinine produced depends on your size and muscle mass. Even though this test result is normal, if you are experiencing any symptoms, you should follow up with your healthcare provider. You can download your lab report to view your results and reference ranges.\"}],\"referenceRange\":[{\"low\":{\"value\":0.67,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"high\":{\"value\":1.17,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"}}]}],\"identifier\":[{\"system\":\"http://letsgetchecked.com/results/barcode\",\"value\":\"LGC-0247-0926-1250\"},{\"system\":\"http://letsgetchecked.com/results/alphaCode\",\"value\":\"AQUBNJ\"}],\"status\":\"final\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"},{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"},{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}]},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"result\":[{\"reference\":\"#57a386f0-84dc-484d-8d75-2cf3f3fe0299\"},{\"reference\":\"#fe27432a-d016-4a84-99d3-5d644850e229\"},{\"reference\":\"#a0b63d0e-fa5a-4487-9550-0b655a44a9f1\"}],\"id\":\"22ae1c07-312e-41e9-9228-57530f1a47bb\"}}],\"total\":1,\"link\":[{\"relation\":\"self\",\"url\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport?identifier=http%3a%2f%2fletsgetchecked.com%2fresults%2fbarcode%7cLGC-0247-0926-1250&_total=accurate&_count=1&_skip=0\"}],\"id\":\"40e703af-6e09-4e43-9634-0d7fafe114af\"}";
        var source = JsonDocument.Parse(json).RootElement;
        
        
        // Act
        var result = Assert.Throws<FhirParseObservationException>(() => { subject.Convert(source, new KedEgfrLabResult(), null); });
    
        // Assert
        Assert.Equal("Observation: No matching observation found or observation value is null. EvaluationId: 457238", result.Message);
    }
    
    [Fact]
    public void Convert_FromJsonElement_To_KedEgfrLabResult_WithObservationNoteNull_Returns_Exception()
    {
        // Arrange
        var subject = new KedEgfrLabResultMapper();
        const string json = "{\"resourceType\":\"Bundle\",\"type\":\"searchset\",\"timestamp\":\"2025-01-14T13:51:54.749+00:00\",\"meta\":{\"lastUpdated\":\"2025-01-14T13:51:54.749+00:00\",\"versionId\":\"d11e70f7-e3f8-4d07-92fb-cbd48058c156\"},\"entry\":[{\"fullUrl\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport/22ae1c07-312e-41e9-9228-57530f1a47bb\",\"search\":{\"mode\":\"match\"},\"resource\":{\"resourceType\":\"DiagnosticReport\",\"meta\":{\"versionId\":\"5b0f9ccd-3283-4932-8c4e-139f460a9257\",\"lastUpdated\":\"2024-11-22T15:20:33.032+00:00\"},\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"identifier\":[{\"system\":\"http://ihr.signify.com/participantId\",\"value\":\"457238\"}],\"name\":[{\"family\":\"Doe\",\"given\":[\"John\"]}],\"telecom\":[{\"system\":\"phone\",\"value\":\"5029997778\"},{\"system\":\"email\",\"value\":\"bkutacho457238@letsgetchecked.com\"}],\"gender\":\"male\",\"birthDate\":\"1998-04-05\",\"address\":[{\"line\":[\"2485 Ice Town Rd\",\"Boston, Kentucky(KY)\"],\"city\":\"Boston\",\"state\":\"California\",\"postalCode\":\"40103\",\"country\":\"US\"}]},{\"resourceType\":\"Practitioner\",\"id\":\"1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"identifier\":[{\"system\":\"http://hl7.org/fhir/sid/us-npi\",\"value\":\"1821020579\"}],\"name\":[{\"family\":\"Mordkin\",\"given\":[\"Robert\"]}]},{\"resourceType\":\"Observation\",\"id\":\"57a386f0-84dc-484d-8d75-2cf3f3fe0299\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"}],\"text\":\"Creatinine\"},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":1,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"note\":[{\"text\":\"Your test result shows your creatinine levels are normal. Creatinine is a waste product produced by your muscles. Your kidneys filter and remove creatinine from the blood and release it into your urine. The amount of creatinine produced depends on your size and muscle mass. Even though this test result is normal, if you are experiencing any symptoms, you should follow up with your healthcare provider. You can download your lab report to view your results and reference ranges.\"}],\"referenceRange\":[{\"low\":{\"value\":0.67,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"},\"high\":{\"value\":1.17,\"unit\":\"mg/dL\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/dL\"}}]},{\"resourceType\":\"Observation\",\"id\":\"fe27432a-d016-4a84-99d3-5d644850e229\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}],\"text\":\"Creatinine in Urine\"},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":120,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"},\"note\":[{\"text\":\"Your Urine Albumin Creatinine ratio (UACR) is normal. This test measures how much albumin is in your urine and found your levels to be normal. When high levels of albumin are found in the urine it can be an early indicator of kidney disease, however, your levels were normal. Please share this test result with your healthcare provider. Even though your test is normal, if you are experiencing any symptoms or are concerned about your health, you should speak to your healthcare provider.\"}],\"referenceRange\":[{\"low\":{\"value\":30,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"},\"high\":{\"value\":300,\"unit\":\"mg/g\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mg/g\"}}]},{\"resourceType\":\"Observation\",\"id\":\"a0b63d0e-fa5a-4487-9550-0b655a44a9f1\",\"status\":\"final\",\"category\":[{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/observation-category\",\"code\":\"laboratory\",\"display\":\"Laboratory\"}],\"text\":\"Laboratory\"}],\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"}],\"text\":\"Estimated Glomerular Filtration Rate\"},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"valueQuantity\":{\"value\":90,\"unit\":\"ml/min/1.73M2\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"ml/min/1.73m2\"},\"note\":[{\"text\":\"\"}],\"referenceRange\":[{\"low\":{\"value\":60,\"unit\":\"ml/min/1.73M2\",\"system\":\"http://unitsofmeasure.org\",\"code\":\"mL/min/1.73m2\"}}]}],\"identifier\":[{\"system\":\"http://letsgetchecked.com/results/barcode\",\"value\":\"LGC-0247-0926-1250\"},{\"system\":\"http://letsgetchecked.com/results/alphaCode\",\"value\":\"AQUBNJ\"}],\"status\":\"final\",\"code\":{\"coding\":[{\"system\":\"http://loinc.org\",\"code\":\"98979-8\",\"display\":\"Estimated Glomerular Filtration Rate\"},{\"system\":\"http://loinc.org\",\"code\":\"2160-0\",\"display\":\"Creatinine\"},{\"system\":\"http://loinc.org\",\"code\":\"14959-1\",\"display\":\"Creatinine in Urine\"}]},\"subject\":{\"reference\":\"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\"display\":\"John Doe\"},\"effectiveDateTime\":\"2024-11-22T15:19:08.894+00:00\",\"performer\":[{\"reference\":\"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\"display\":\"Robert Mordkin\"}],\"result\":[{\"reference\":\"#57a386f0-84dc-484d-8d75-2cf3f3fe0299\"},{\"reference\":\"#fe27432a-d016-4a84-99d3-5d644850e229\"},{\"reference\":\"#a0b63d0e-fa5a-4487-9550-0b655a44a9f1\"}],\"id\":\"22ae1c07-312e-41e9-9228-57530f1a47bb\"}}],\"total\":1,\"link\":[{\"relation\":\"self\",\"url\":\"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport?identifier=http%3a%2f%2fletsgetchecked.com%2fresults%2fbarcode%7cLGC-0247-0926-1250&_total=accurate&_count=1&_skip=0\"}],\"id\":\"40e703af-6e09-4e43-9634-0d7fafe114af\"}";
        var source = JsonDocument.Parse(json).RootElement;
        
        // Act
        var result = Assert.Throws<FhirParseObservationException>(() => { subject.Convert(source, new KedEgfrLabResult(), null); });
    
        // Assert
        Assert.Equal("Observation: No matching observation found or observation value is null. EvaluationId: 457238", result.Message);
    }

    [Theory]
    [InlineData("mg/dL")]
    [InlineData("g/L")]
    [InlineData("mmol/L")]
    [InlineData("mg/g")]
    public void Convert_FromJsonElement_To_KedUacrLabResult_WithInvalidUnits_Throws_FhirParseException(
        string invalidUnit)
    {
        // Arrange
        var subject = new KedEgfrLabResultMapper();
        string json =
            "{\r\n    \"resourceType\": \"Bundle\",\r\n    \"type\": \"searchset\",\r\n    \"timestamp\": \"2025-01-14T13:51:54.749+00:00\",\r\n    \"meta\": {\r\n        \"lastUpdated\": \"2025-01-14T13:51:54.749+00:00\",\r\n        \"versionId\": \"d11e70f7-e3f8-4d07-92fb-cbd48058c156\"\r\n    },\r\n    \"entry\": [\r\n        {\r\n            \"fullUrl\": \"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport/22ae1c07-312e-41e9-9228-57530f1a47bb\",\r\n            \"search\": {\r\n                \"mode\": \"match\"\r\n            },\r\n            \"resource\": {\r\n                \"resourceType\": \"DiagnosticReport\",\r\n                \"meta\": {\r\n                    \"versionId\": \"5b0f9ccd-3283-4932-8c4e-139f460a9257\",\r\n                    \"lastUpdated\": \"2024-11-22T15:20:33.032+00:00\"\r\n                },\r\n                \"contained\": [\r\n                    {\r\n                        \"resourceType\": \"Patient\",\r\n                        \"id\": \"f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                        \"identifier\": [\r\n                            {\r\n                                \"system\": \"http://ihr.signify.com/participantId\",\r\n                                \"value\": \"566215\"\r\n                            }\r\n                        ],\r\n                        \"name\": [\r\n                            {\r\n                                \"family\": \"Doe\",\r\n                                \"given\": [\r\n                                    \"John\"\r\n                                ]\r\n                            }\r\n                        ],\r\n                        \"telecom\": [\r\n                            {\r\n                                \"system\": \"phone\",\r\n                                \"value\": \"5029997778\"\r\n                            },\r\n                            {\r\n                                \"system\": \"email\",\r\n                                \"value\": \"bkutacho457238@letsgetchecked.com\"\r\n                            }\r\n                        ],\r\n                        \"gender\": \"male\",\r\n                        \"birthDate\": \"1998-04-05\",\r\n                        \"address\": [\r\n                            {\r\n                                \"line\": [\r\n                                    \"2485 Ice Town Rd\",\r\n                                    \"Boston, Kentucky(KY)\"\r\n                                ],\r\n                                \"city\": \"Boston\",\r\n                                \"state\": \"California\",\r\n                                \"postalCode\": \"40103\",\r\n                                \"country\": \"US\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Practitioner\",\r\n                        \"id\": \"1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                        \"identifier\": [\r\n                            {\r\n                                \"system\": \"http://hl7.org/fhir/sid/us-npi\",\r\n                                \"value\": \"1821020579\"\r\n                            }\r\n                        ],\r\n                        \"name\": [\r\n                            {\r\n                                \"family\": \"Mordkin\",\r\n                                \"given\": [\r\n                                    \"Robert\"\r\n                                ]\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Observation\",\r\n                        \"id\": \"57a386f0-84dc-484d-8d75-2cf3f3fe0299\",\r\n                        \"status\": \"final\",\r\n                        \"category\": [\r\n                            {\r\n                                \"coding\": [\r\n                                    {\r\n                                        \"system\": \"http://terminology.hl7.org/CodeSystem/observation-category\",\r\n                                        \"code\": \"laboratory\",\r\n                                        \"display\": \"Laboratory\"\r\n                                    }\r\n                                ],\r\n                                \"text\": \"Laboratory\"\r\n                            }\r\n                        ],\r\n                        \"code\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"http://loinc.org\",\r\n                                    \"code\": \"2160-0\",\r\n                                    \"display\": \"Creatinine\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"Creatinine\"\r\n                        },\r\n                        \"subject\": {\r\n                            \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                            \"display\": \"John Doe\"\r\n                        },\r\n                        \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                        \"performer\": [\r\n                            {\r\n                                \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                                \"display\": \"Robert Mordkin\"\r\n                            }\r\n                        ],\r\n                        \"valueQuantity\": {\r\n                            \"value\": 1,\r\n                            \"unit\": \"mg/dL\",\r\n                            \"system\": \"http://unitsofmeasure.org\",\r\n                            \"code\": \"mg/dL\"\r\n                        },\r\n                        \"note\": [\r\n                            {\r\n                                \"text\": \"Your test result shows your creatinine levels are normal. Creatinine is a waste product produced by your muscles. Your kidneys filter and remove creatinine from the blood and release it into your urine. The amount of creatinine produced depends on your size and muscle mass. Even though this test result is normal, if you are experiencing any symptoms, you should follow up with your healthcare provider. You can download your lab report to view your results and reference ranges.\"\r\n                            }\r\n                        ],\r\n                        \"referenceRange\": [\r\n                            {\r\n                                \"low\": {\r\n                                    \"value\": 0.67,\r\n                                    \"unit\": \"mg/dL\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/dL\"\r\n                                },\r\n                                \"high\": {\r\n                                    \"value\": 1.17,\r\n                                    \"unit\": \"mg/dL\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/dL\"\r\n                                }\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Observation\",\r\n                        \"id\": \"fe27432a-d016-4a84-99d3-5d644850e229\",\r\n                        \"status\": \"final\",\r\n                        \"category\": [\r\n                            {\r\n                                \"coding\": [\r\n                                    {\r\n                                        \"system\": \"http://terminology.hl7.org/CodeSystem/observation-category\",\r\n                                        \"code\": \"laboratory\",\r\n                                        \"display\": \"Laboratory\"\r\n                                    }\r\n                                ],\r\n                                \"text\": \"Laboratory\"\r\n                            }\r\n                        ],\r\n                        \"code\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"http://loinc.org\",\r\n                                    \"code\": \"14959-1\",\r\n                                    \"display\": \"Creatinine in Urine\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"Creatinine in Urine\"\r\n                        },\r\n                        \"subject\": {\r\n                            \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                            \"display\": \"John Doe\"\r\n                        },\r\n                        \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                        \"performer\": [\r\n                            {\r\n                                \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                                \"display\": \"Robert Mordkin\"\r\n                            }\r\n                        ],\r\n                        \"valueQuantity\": {\r\n                            \"value\": 120,\r\n                            \"unit\": \"mg/g\",\r\n                            \"system\": \"http://unitsofmeasure.org\",\r\n                            \"code\": \"mg/g\"\r\n                        },\r\n                        \"note\": [\r\n                            {\r\n                                \"text\": \"Your Urine Albumin Creatinine ratio (UACR) is normal. This test measures how much albumin is in your urine and found your levels to be normal. When high levels of albumin are found in the urine it can be an early indicator of kidney disease, however, your levels were normal. Please share this test result with your healthcare provider. Even though your test is normal, if you are experiencing any symptoms or are concerned about your health, you should speak to your healthcare provider.\"\r\n                            }\r\n                        ],\r\n                        \"referenceRange\": [\r\n                            {\r\n                                \"low\": {\r\n                                    \"value\": 30,\r\n                                    \"unit\": \"mg/g\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/g\"\r\n                                },\r\n                                \"high\": {\r\n                                    \"value\": 300,\r\n                                    \"unit\": \"mg/g\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mg/g\"\r\n                                }\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"resourceType\": \"Observation\",\r\n                        \"id\": \"a0b63d0e-fa5a-4487-9550-0b655a44a9f1\",\r\n                        \"status\": \"final\",\r\n                        \"category\": [\r\n                            {\r\n                                \"coding\": [\r\n                                    {\r\n                                        \"system\": \"http://terminology.hl7.org/CodeSystem/observation-category\",\r\n                                        \"code\": \"laboratory\",\r\n                                        \"display\": \"Laboratory\"\r\n                                    }\r\n                                ],\r\n                                \"text\": \"Laboratory\"\r\n                            }\r\n                        ],\r\n                        \"code\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"http://loinc.org\",\r\n                                    \"code\": \"98979-8\",\r\n                                    \"display\": \"Estimated Glomerular Filtration Rate\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"Estimated Glomerular Filtration Rate\"\r\n                        },\r\n                        \"subject\": {\r\n                            \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                            \"display\": \"John Doe\"\r\n                        },\r\n                        \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                        \"performer\": [\r\n                            {\r\n                                \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                                \"display\": \"Robert Mordkin\"\r\n                            }\r\n                        ],\r\n                        \"valueQuantity\": {\r\n                            \"value\": 90,\r\n                            \"unit\": \"ml/min/1.73M2\",\r\n                            \"system\": \"http://unitsofmeasure.org\",\r\n                            \"code\": \"" +
            invalidUnit +
            "\"\r\n                        },\r\n                        \"note\": [\r\n                            {\r\n                                \"text\": \"Your eGFR result is normal. This result is an estimated calculation that helps determine how well your kidneys are filtering blood using different factors including your creatinine level, age, and sex. A result between 60 and 90 shows slightly reduced kidney function. This can be a result of many factors including infection, certain medications, or health conditions or it could be an early sign of kidney disease. You should share this result with your healthcare provider to assess your risk of kidney disease. A result above 90 is optimal. The best ways to keep your kidneys healthy are staying hydrated, a healthy balanced diet, exercise, and not smoking. It’s important to check for health conditions such as diabetes, high blood pressure, and high cholesterol. If you have any of these conditions it is very important to keep your blood sugar levels, blood pressure, and cholesterol under control and to speak to your healthcare provider about how best to manage your risk.\"\r\n                            }\r\n                        ],\r\n                        \"referenceRange\": [\r\n                            {\r\n                                \"low\": {\r\n                                    \"value\": 60,\r\n                                    \"unit\": \"ml/min/1.73M2\",\r\n                                    \"system\": \"http://unitsofmeasure.org\",\r\n                                    \"code\": \"mL/min/1.73m2\"\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                ],\r\n                \"identifier\": [\r\n                    {\r\n                        \"system\": \"http://letsgetchecked.com/results/barcode\",\r\n                        \"value\": \"LGC-0247-0926-1250\"\r\n                    },\r\n                    {\r\n                        \"system\": \"http://letsgetchecked.com/results/alphaCode\",\r\n                        \"value\": \"AQUBNJ\"\r\n                    }\r\n                ],\r\n                \"status\": \"final\",\r\n                \"code\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"http://loinc.org\",\r\n                            \"code\": \"98979-8\",\r\n                            \"display\": \"Estimated Glomerular Filtration Rate\"\r\n                        },\r\n                        {\r\n                            \"system\": \"http://loinc.org\",\r\n                            \"code\": \"2160-0\",\r\n                            \"display\": \"Creatinine\"\r\n                        },\r\n                        {\r\n                            \"system\": \"http://loinc.org\",\r\n                            \"code\": \"14959-1\",\r\n                            \"display\": \"Creatinine in Urine\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"subject\": {\r\n                    \"reference\": \"#f5e2872d-82b9-49dc-aafe-84357a422ca9\",\r\n                    \"display\": \"John Doe\"\r\n                },\r\n                \"effectiveDateTime\": \"2024-11-22T15:19:08.894+00:00\",\r\n                \"performer\": [\r\n                    {\r\n                        \"reference\": \"#1657d868-0cd1-46f7-8aa6-eee9a1f4cef5\",\r\n                        \"display\": \"Robert Mordkin\"\r\n                    }\r\n                ],\r\n                \"result\": [\r\n                    {\r\n                        \"reference\": \"#57a386f0-84dc-484d-8d75-2cf3f3fe0299\"\r\n                    },\r\n                    {\r\n                        \"reference\": \"#fe27432a-d016-4a84-99d3-5d644850e229\"\r\n                    },\r\n                    {\r\n                        \"reference\": \"#a0b63d0e-fa5a-4487-9550-0b655a44a9f1\"\r\n                    }\r\n                ],\r\n                \"id\": \"22ae1c07-312e-41e9-9228-57530f1a47bb\"\r\n            }\r\n        }\r\n    ],\r\n    \"total\": 1,\r\n    \"link\": [\r\n        {\r\n            \"relation\": \"self\",\r\n            \"url\": \"https://b2b-fhir-api.letsgetchecked-stg2.com/DiagnosticReport?identifier=http%3a%2f%2fletsgetchecked.com%2fresults%2fbarcode%7cLGC-0247-0926-1250&_total=accurate&_count=1&_skip=0\"\r\n        }\r\n    ],\r\n    \"id\": \"40e703af-6e09-4e43-9634-0d7fafe114af\"\r\n}";

        var source = JsonDocument.Parse(json).RootElement;

        // Act
        var exception = Assert.Throws<FhirParseObservationException>(() => subject.Convert(source, new KedEgfrLabResult(), null));

        // Assert
        Assert.Equal($"Observation: Invalid units:{invalidUnit} EvaluationId: 566215", exception.Message);
    }
}